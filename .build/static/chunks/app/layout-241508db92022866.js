(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{64617:function(e,t,r){Promise.resolve().then(r.bind(r,27674)),Promise.resolve().then(r.t.bind(r,65091,23)),Promise.resolve().then(r.t.bind(r,9662,23))},27674:function(e,t,r){"use strict";r.d(t,{Providers:function(){return A}});var s=r(15444),n=r(75762),a=r(89300),o=r(41844);function i({children:e,...t}){return(0,s.jsx)(o.f,{...t,children:e})}var c=r(34669),l=r(95854);class d{constructor(){this.isSyncing=!1}static getInstance(){return d.instance||(d.instance=new d),d.instance}async syncAllTransactions(){if(this.isSyncing){console.log("[SyncManager] Sync already in progress");return}if(!navigator.onLine){console.log("[SyncManager] Device is offline, skipping sync");return}this.isSyncing=!0,console.log("[SyncManager] Starting sync...");try{let e=await c.N.getUnsyncedTransactions();if(console.log(`[SyncManager] Found ${e.length} unsynced transactions`),0===e.length){this.isSyncing=!1;return}let t={success:0,failed:0};for(let r of e)try{await this.syncTransaction(r),await c.N.markTransactionSynced(r.id),t.success++}catch(e){console.error("[SyncManager] Failed to sync transaction:",r.id,e),t.failed++}console.log("[SyncManager] Sync completed:",t),t.success>0&&(0,l.Am)({title:"Sync Complete",description:`Successfully synced ${t.success} transaction(s)${t.failed>0?`. ${t.failed} failed.`:""}`}),t.failed>0&&(0,l.Am)({title:"Sync Warning",description:`${t.failed} transaction(s) failed to sync. Will retry on next sync.`,variant:"destructive"})}catch(e){console.error("[SyncManager] Sync error:",e),(0,l.Am)({title:"Sync Error",description:"Failed to sync offline transactions. Will retry later.",variant:"destructive"})}finally{this.isSyncing=!1}}async syncTransaction(e){switch(e.type){case"sale":return this.syncSale(e.data);case"product":return this.syncProduct(e.data);case"customer":return this.syncCustomer(e.data);case"return":return this.syncReturn(e.data);default:throw Error(`Unknown transaction type: ${e.type}`)}}async syncSale(e){let t=await fetch("/api/sales",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error(`Failed to sync sale: ${t.statusText}`)}async syncProduct(e){let t=e.id?"PUT":"POST",r=e.id?`/api/products/${e.id}`:"/api/products",s=await fetch(r,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw Error(`Failed to sync product: ${s.statusText}`)}async syncCustomer(e){let t=e.id?"PUT":"POST",r=e.id?`/api/customers/${e.id}`:"/api/customers",s=await fetch(r,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw Error(`Failed to sync customer: ${s.statusText}`)}async syncReturn(e){let t=await fetch("/api/returns",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error(`Failed to sync return: ${t.statusText}`)}async cacheDataForOffline(){try{let e=await fetch("/api/products");if(e.ok){let t=await e.json();await c.N.cacheProducts(t)}let t=await fetch("/api/customers");if(t.ok){let e=await t.json();await c.N.cacheCustomers(e)}let r=await fetch("/api/categories");if(r.ok){let e=await r.json();await c.N.cacheCategories(e)}console.log("[SyncManager] Data cached successfully")}catch(e){console.error("[SyncManager] Failed to cache data:",e)}}}let u=d.getInstance();function f(){return(0,a.useEffect)(()=>{c.N.init().then(()=>{console.log("[PWA] IndexedDB initialized")}),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("[PWA] Service Worker registered:",e),navigator.serviceWorker.addEventListener("message",e=>{e.data&&"SYNC_TRANSACTIONS"===e.data.type&&window.dispatchEvent(new Event("sync-transactions"))})}).catch(e=>{console.error("[PWA] Service Worker registration failed:",e)});let e=()=>{console.log("[PWA] Sync event triggered"),u.syncAllTransactions()};window.addEventListener("sync-transactions",e),navigator.onLine&&u.cacheDataForOffline();let t=setInterval(()=>{navigator.onLine&&u.cacheDataForOffline()},3e5);return()=>{window.removeEventListener("sync-transactions",e),clearInterval(t)}},[]),null}var m=r(26584),h=r(33485),g=r(2422);function p(){let[e,t]=(0,a.useState)(null),[r,n]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let e=e=>{e.preventDefault(),t(e),n(!0)};return window.addEventListener("beforeinstallprompt",e),()=>{window.removeEventListener("beforeinstallprompt",e)}},[]);let o=async()=>{if(!e)return;e.prompt();let{outcome:r}=await e.userChoice;"accepted"===r?console.log("[InstallPrompt] User accepted the install prompt"):console.log("[InstallPrompt] User dismissed the install prompt"),t(null),n(!1)},i=()=>{n(!1)};return r?(0,s.jsx)("div",{className:"fixed bottom-4 right-4 z-50 max-w-sm animate-in slide-in-from-bottom",children:(0,s.jsx)("div",{className:"rounded-lg bg-white p-4 shadow-lg border border-gray-200",children:(0,s.jsxs)("div",{className:"flex items-start space-x-3",children:[(0,s.jsx)("div",{className:"flex-shrink-0",children:(0,s.jsx)(m.Z,{className:"h-6 w-6 text-emerald-600"})}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold text-gray-900",children:"Install POS System"}),(0,s.jsx)("p",{className:"mt-1 text-sm text-gray-600",children:"Install this app on your desktop for quick access and offline support!"}),(0,s.jsxs)("div",{className:"mt-3 flex space-x-2",children:[(0,s.jsx)(g.z,{onClick:o,size:"sm",className:"bg-emerald-600 hover:bg-emerald-700",children:"Install"}),(0,s.jsx)(g.z,{onClick:i,size:"sm",variant:"outline",children:"Not now"})]})]}),(0,s.jsx)("button",{onClick:i,className:"flex-shrink-0 text-gray-400 hover:text-gray-600",children:(0,s.jsx)(h.Z,{className:"h-5 w-5"})})]})})}):null}var y=r(51692),v=r(2371),S=r(65522);let x=y.zt,b=a.forwardRef(({className:e,...t},r)=>(0,s.jsx)(y.l_,{ref:r,className:(0,S.cn)("fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",e),...t}));b.displayName=y.l_.displayName;let w=(0,v.j)("group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",{variants:{variant:{default:"border bg-background text-foreground",destructive:"destructive group border-destructive bg-destructive text-destructive-foreground"}},defaultVariants:{variant:"default"}}),j=a.forwardRef(({className:e,variant:t,...r},n)=>(0,s.jsx)(y.fC,{ref:n,className:(0,S.cn)(w({variant:t}),e),...r}));j.displayName=y.fC.displayName,a.forwardRef(({className:e,...t},r)=>(0,s.jsx)(y.aU,{ref:r,className:(0,S.cn)("inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",e),...t})).displayName=y.aU.displayName;let N=a.forwardRef(({className:e,...t},r)=>(0,s.jsx)(y.x8,{ref:r,className:(0,S.cn)("absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",e),"toast-close":"",...t,children:(0,s.jsx)(h.Z,{className:"h-4 w-4"})}));N.displayName=y.x8.displayName;let T=a.forwardRef(({className:e,...t},r)=>(0,s.jsx)(y.Dx,{ref:r,className:(0,S.cn)("text-sm font-semibold",e),...t}));T.displayName=y.Dx.displayName;let P=a.forwardRef(({className:e,...t},r)=>(0,s.jsx)(y.dk,{ref:r,className:(0,S.cn)("text-sm opacity-90",e),...t}));function E(){let{toasts:e}=(0,l.pm)();return(0,s.jsxs)(x,{children:[e.map(function({id:e,title:t,description:r,action:n,...a}){return(0,s.jsxs)(j,{...a,children:[(0,s.jsxs)("div",{className:"grid gap-1",children:[t&&(0,s.jsx)(T,{children:t}),r&&(0,s.jsx)(P,{children:r})]}),n,(0,s.jsx)(N,{})]},e)}),(0,s.jsx)(b,{})]})}P.displayName=y.dk.displayName;var I=r(82534),k=r(3857),C=r(95777);function A({children:e}){let[t,r]=(0,a.useState)(!1);return((0,a.useEffect)(()=>{r(!0)},[]),t)?(0,s.jsx)(n.SessionProvider,{children:(0,s.jsx)(I.g,{children:(0,s.jsx)(k.T3,{children:(0,s.jsx)(C.Hn,{children:(0,s.jsxs)(i,{attribute:"class",defaultTheme:"light",enableSystem:!0,disableTransitionOnChange:!0,children:[(0,s.jsx)(f,{}),(0,s.jsx)(p,{}),(0,s.jsx)(E,{}),e]})})})})}):null}},95777:function(e,t,r){"use strict";r.d(t,{Ap:function(){return i},FE:function(){return l},Hn:function(){return c}});var s=r(15444),n=r(75762),a=r(89300);let o=(0,a.createContext)({isPinned:!0,setIsPinned:e=>{}}),i=()=>(0,a.useContext)(o);function c({children:e}){let[t,r]=(0,a.useState)(!0);return(0,a.useEffect)(()=>{let e=localStorage.getItem("sidebar-pinned");null!==e&&r("true"===e)},[]),(0,a.useEffect)(()=>{localStorage.setItem("sidebar-pinned",String(t))},[t]),(0,s.jsx)(o.Provider,{value:{isPinned:t,setIsPinned:r},children:e})}function l({children:e}){let{data:t}=(0,n.useSession)()||{},r=t?.user?.role,{isPinned:a}=i();return"CASHIER"===r?(0,s.jsx)("main",{children:e}):(0,s.jsx)("main",{className:`min-h-screen pt-16 transition-all duration-300 ${a?"lg:ml-64":"lg:ml-16"}`,children:e})}},2422:function(e,t,r){"use strict";r.d(t,{z:function(){return l}});var s=r(15444),n=r(89300),a=r(21030),o=r(2371),i=r(65522);let c=(0,o.j)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),l=n.forwardRef(({className:e,variant:t,size:r,asChild:n=!1,...o},l)=>{let d=n?a.g7:"button";return(0,s.jsx)(d,{className:(0,i.cn)(c({variant:t,size:r,className:e})),ref:l,...o})});l.displayName="Button"},95854:function(e,t,r){"use strict";r.d(t,{Am:function(){return u},pm:function(){return f}});var s=r(89300);let n=0,a=new Map,o=e=>{if(a.has(e))return;let t=setTimeout(()=>{a.delete(e),d({type:"REMOVE_TOAST",toastId:e})},1e6);a.set(e,t)},i=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:r}=t;return r?o(r):e.toasts.forEach(e=>{o(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===r||void 0===r?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},c=[],l={toasts:[]};function d(e){l=i(l,e),c.forEach(e=>{e(l)})}function u({...e}){let t=(n=(n+1)%Number.MAX_SAFE_INTEGER).toString(),r=()=>d({type:"DISMISS_TOAST",toastId:t});return d({type:"ADD_TOAST",toast:{...e,id:t,open:!0,onOpenChange:e=>{e||r()}}}),{id:t,dismiss:r,update:e=>d({type:"UPDATE_TOAST",toast:{...e,id:t}})}}function f(){let[e,t]=s.useState(l);return s.useEffect(()=>(c.push(t),()=>{let e=c.indexOf(t);e>-1&&c.splice(e,1)}),[e]),{...e,toast:u,dismiss:e=>d({type:"DISMISS_TOAST",toastId:e})}}},3857:function(e,t,r){"use strict";r.d(t,{Mf:function(){return a},T3:function(){return i},U8:function(){return c}});var s=r(15444),n=r(89300);let a=[{code:"KES",symbol:"KSh",name:"Kenyan Shilling",rate:1},{code:"USD",symbol:"$",name:"US Dollar",rate:.0065},{code:"EUR",symbol:"€",name:"Euro",rate:.006},{code:"GBP",symbol:"\xa3",name:"British Pound",rate:.0051},{code:"TZS",symbol:"TSh",name:"Tanzanian Shilling",rate:16.5},{code:"UGX",symbol:"USh",name:"Ugandan Shilling",rate:24},{code:"ZAR",symbol:"R",name:"South African Rand",rate:.12},{code:"NGN",symbol:"₦",name:"Nigerian Naira",rate:10}],o=(0,n.createContext)(void 0);function i({children:e}){let[t,r]=(0,n.useState)(a[0]),[i,c]=(0,n.useState)(!1);(0,n.useEffect)(()=>{c(!0);let e=localStorage.getItem("pos-currency");if(e){let t=a.find(t=>t.code===e);t&&r(t)}},[]);let l=e=>e*t.rate,d={currency:i?t:a[0],setCurrency:e=>{r(e),localStorage.setItem("pos-currency",e.code)},formatPrice:i?e=>{let r=l(e);return`${t.symbol} ${r.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`}:e=>`KSh ${e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`,convertPrice:i?l:e=>e};return(0,s.jsx)(o.Provider,{value:d,children:e})}function c(){let e=(0,n.useContext)(o);if(!e)throw Error("useCurrency must be used within a CurrencyProvider");return e}},82534:function(e,t,r){"use strict";r.d(t,{g:function(){return i},o:function(){return c}});var s=r(15444),n=r(89300),a=r(75762);let o=(0,n.createContext)(void 0);function i({children:e}){let{data:t,status:r}=(0,a.useSession)()||{},[i,c]=(0,n.useState)(null),[l,d]=(0,n.useState)([]),[u,f]=(0,n.useState)(!0),m=async()=>{try{f(!0);let e=await fetch("/api/stores");if(e.ok){let r=await e.json();if(d(r),t?.user){let e=t.user?.storeId;if(e){let t=r.find(t=>t.id===e);t&&(c(t),localStorage.setItem("selectedStoreId",t.id))}else{let e=localStorage.getItem("selectedStoreId");if(e){let t=r.find(t=>t.id===e);if(t)c(t);else{let e=r.find(e=>e.isActive);e&&(c(e),localStorage.setItem("selectedStoreId",e.id))}}else{let e=r.find(e=>e.isActive);e&&(c(e),localStorage.setItem("selectedStoreId",e.id))}}}}}catch(e){console.error("Error fetching stores:",e)}finally{f(!1)}};return(0,n.useEffect)(()=>{"authenticated"===r?m():"unauthenticated"===r&&f(!1)},[r,t?.user]),(0,s.jsx)(o.Provider,{value:{selectedStore:i,setSelectedStore:e=>{c(e),e?localStorage.setItem("selectedStoreId",e.id):localStorage.removeItem("selectedStoreId")},stores:l,loading:u,refreshStores:m},children:e})}function c(){let e=(0,n.useContext)(o);if(void 0===e)throw Error("useStore must be used within a StoreProvider");return e}},34669:function(e,t,r){"use strict";r.d(t,{N:function(){return n}});class s{async init(){return new Promise((e,t)=>{let r=indexedDB.open("pos_offline_db",1);r.onerror=()=>t(r.error),r.onsuccess=()=>{this.db=r.result,e()},r.onupgradeneeded=e=>{let t=e.target.result;if(!t.objectStoreNames.contains("transactions")){let e=t.createObjectStore("transactions",{keyPath:"id"});e.createIndex("synced","synced",{unique:!1}),e.createIndex("type","type",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains("products")||t.createObjectStore("products",{keyPath:"id"}),t.objectStoreNames.contains("customers")||t.createObjectStore("customers",{keyPath:"id"}),t.objectStoreNames.contains("categories")||t.createObjectStore("categories",{keyPath:"id"})}})}async addTransaction(e){return this.db||await this.init(),new Promise((t,r)=>{let s=this.db.transaction("transactions","readwrite").objectStore("transactions").add(e);s.onsuccess=()=>t(),s.onerror=()=>r(s.error)})}async getUnsyncedTransactions(){return this.db||await this.init(),new Promise((e,t)=>{let r=this.db.transaction("transactions","readonly").objectStore("transactions").index("synced").getAll(IDBKeyRange.only(!1));r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async markTransactionSynced(e){return this.db||await this.init(),new Promise((t,r)=>{let s=this.db.transaction("transactions","readwrite").objectStore("transactions"),n=s.get(e);n.onsuccess=()=>{let e=n.result;if(e){e.synced=!0;let n=s.put(e);n.onsuccess=()=>t(),n.onerror=()=>r(n.error)}else t()},n.onerror=()=>r(n.error)})}async cacheProducts(e){return this.db||await this.init(),new Promise((t,r)=>{let s=this.db.transaction("products","readwrite"),n=s.objectStore("products");n.clear().onsuccess=()=>{e.forEach(e=>{n.add(e)})},s.oncomplete=()=>t(),s.onerror=()=>r(s.error)})}async getCachedProducts(){return this.db||await this.init(),new Promise((e,t)=>{let r=this.db.transaction("products","readonly").objectStore("products").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async cacheCustomers(e){return this.db||await this.init(),new Promise((t,r)=>{let s=this.db.transaction("customers","readwrite"),n=s.objectStore("customers");n.clear().onsuccess=()=>{e.forEach(e=>{n.add(e)})},s.oncomplete=()=>t(),s.onerror=()=>r(s.error)})}async getCachedCustomers(){return this.db||await this.init(),new Promise((e,t)=>{let r=this.db.transaction("customers","readonly").objectStore("customers").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async cacheCategories(e){return this.db||await this.init(),new Promise((t,r)=>{let s=this.db.transaction("categories","readwrite"),n=s.objectStore("categories");n.clear().onsuccess=()=>{e.forEach(e=>{n.add(e)})},s.oncomplete=()=>t(),s.onerror=()=>r(s.error)})}async getCachedCategories(){return this.db||await this.init(),new Promise((e,t)=>{let r=this.db.transaction("categories","readonly").objectStore("categories").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}constructor(){this.db=null}}let n=new s},65522:function(e,t,r){"use strict";r.d(t,{cn:function(){return a}});var s=r(32191),n=r(23607);function a(...e){return(0,n.m6)((0,s.W)(e))}},9662:function(){}},function(e){e.O(0,[854,676,258,501,386,156,744],function(){return e(e.s=64617)}),_N_E=e.O()}]);